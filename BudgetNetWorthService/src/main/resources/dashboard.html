<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BNW: Dashboard</title>
    <link
            href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <style>
        hr {
            border: 0;
            border-top: 2px solid darkgray;
            border-radius: 5px;
        }

        .accent-bar {
            position: relative;
            height: 25px;
        }

        ul.accents li {
            display: inline;
            margin-left: 5px;
        }
    </style>
    <script type="text/javascript">
        const headerInputs = [
            '#transaction-date-header',
            '#memo-header',
            '#debit-header',
            '#credit-header'
        ];
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#create-account").submit(function (event) {
                event.preventDefault();

                const formData = new FormData(event.target);
                const formDataObj = {};
                formData.forEach((value, key) => (formDataObj[key] = value));

                $.ajax({
                    type: "POST",
                    url: event.target.action,
                    data: formDataObj,
                    dataType: "json",
                    success: function (response) {
                        event.target.reset();
                        appendAccountToAccountsTable(response);
                        appendAccountToUploadTransactionsList(response);
                    }
                });

            });

        });
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#upload-transactions").submit(function (event) {
                event.preventDefault();

                const formData = event.target;
                const action = "accounts/" + formData["file-account"].value + "/stage-upload";
                const transactionsFile = $("#transactions-file");
                const fileInput = transactionsFile[0];
                const file = fileInput.files[0];
                const fd = new FormData();
                fd.append('file', file);

                $.ajax({
                    type: "POST",
                    dataType: "json",
                    processData: false,
                    contentType: false,
                    url: action,
                    data: fd,
                    success: function (response) {
                        event.target.reset();

                        response.uploadHeaders.forEach(function (item) {
                            headerInputs.forEach(function (headerInput) {
                                $(headerInput).append(
                                    $('<option></option>').val(item.id).html(item.value)
                                );
                                $(headerInput + ' option').each(function () {
                                    if (this.defaultSelected) {
                                        this.selected = true;
                                        return false;
                                    }
                                });
                            });
                        });

                        $('#map-headers').attr('action', "uploads/" + response.uploadId + "/map-headers");
                        $('#map-headers-wrapper').show(500);
                    }
                });
            });
        })
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#map-headers").submit(function (event) {
                event.preventDefault();

                const formData = new FormData(event.target);
                const formDataObj = {};
                formData.forEach((value, key) => (formDataObj[key] = value));

                $.ajax({
                    type: "POST",
                    url: event.target.action,
                    data: formDataObj,
                    dataType: "json",
                    success: function (response) {
                        const formatter = new Intl.NumberFormat('en-US', {
                            style: 'currency',
                            currency: 'USD',
                        });
                        $("#review-upload-table tr").remove();
                        response.mappedUploadRows.forEach(function (item) {
                            const trHtml = '<tr><td>' + item.date[1] + '/' + item.date[2] + '/' + item.date[0] + '</td>' +
                                '<td>' + item.memo + '</td><td>' + formatter.format(item.debit) + '</td></tr>';
                            $("#review-upload-table").append(trHtml);
                        });
                        $("#finalize-upload").attr('action', "uploads/" + response.uploadId + "/finalize");
                        $('#finalize-upload-wrapper').show(500);
                    }
                });
            });
        })
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#finalize-upload").submit(function (event) {
                event.preventDefault();
                console.log(event);

                $.ajax({
                    type: "POST",
                    url: event.target.action,
                    dataType: "json",
                    success: function (response) {
                        console.log(response);
                        headerInputs.forEach(function (headerInput) {
                            $(headerInput + " > option").each(function () {
                                if (this.value) {
                                    this.remove();
                                }
                            })
                        });
                        $("#review-upload-table tr").remove();
                        $("#finalize-upload").attr('action', '');
                        $('#map-headers').attr('action', '');
                        $('#map-headers-wrapper').hide();
                        $('#finalize-upload-wrapper').hide();
                    }
                })
            });
        });
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#menu-accounts").click(function () {
                $('#upload-page').hide();
                $('#transactions-page').hide();
                $('#accounts-page').show();
            });
        });
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#menu-uploads").click(function () {
                $('#accounts-page').hide();
                $('#transactions-page').hide();
                $('#upload-page').show();
            });
        });
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#menu-transactions").click(function () {
                $('#accounts-page').hide();
                $('#upload-page').hide();
                $('#transactions-page').show();
            });
        });
    </script>
    <script type="text/javascript">
        function populateTables() {
            populateAccountsTable();
            populateTransactionsTable()
        }
    </script>
    <script type="text/javascript">
        function populateAccountsTable() {
            $.ajax({
                type: "GET",
                url: "accounts",
                dataType: "json",
                success: function (response) {
                    if (response !== undefined && response.length >= 0) {
                        $.each(response, function (i, item) {
                            appendAccountToAccountsTable(item);
                            appendAccountToUploadTransactionsList(item);
                        });
                    }
                }
            });
        }
    </script>
    <script type="text/javascript">
        function populateTransactionsTable() {
            $.ajax({
                type: "GET",
                url: "/transactions",
                dataType: "json",
                success: function (response) {
                    if (response !== undefined && response.length >= 0) {
                        $("#review-upload-table tr").remove();
                        $.each(response, function (i, item) {
                            appendTransactionToTransactionsTable(item);
                        });
                    }
                }
            });
        }
    </script>
    <script type="text/javascript">
        function appendTransactionToTransactionsTable(item) {
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            });
            const trHtml = '<tr><td>' + item.date[1] + '/' + item.date[2] + '/' + item.date[0] + '</td>' +
                '<td>' + item.memo + '</td><td>' + formatter.format(item.amount) + '</td></tr>';
            $("#transactions-table").append(trHtml);
        }
    </script>
    <script type="text/javascript">
        function appendAccountToAccountsTable(item) {
            const trHtml = '<tr id ="' + item.id + '"><td>' + item.accountName + '</td><td><button type="button"' +
                ' class="btn btn-danger" value="' + item.id + '" onclick="deleteAccount(this.value);" style="float: right;">Delete</button></td></tr>';
            $('#accounts-table').append(trHtml);
        }
    </script>
    <script type="text/javascript">
        function appendAccountToUploadTransactionsList(item) {
            const select = document.getElementById('file-account');
            select.options[select.options.length] = new Option(item.accountName, item.id);
        }
    </script>
    <script type="text/javascript">
        function deleteAccount(id) {
            $.ajax({
                type: "DELETE",
                url: "accounts/" + id,
                dataType: "json",
                success: function () {
                    $('#' + id).remove();
                    document.getElementById('file-account').remove(id);

                    const fileAccountOptions = document.getElementById("file-account");
                    for (let i = 0; i < fileAccountOptions.length; i++) {
                        if (fileAccountOptions.options[i].value === id) {
                            fileAccountOptions.options[i].remove();
                        }
                    }
                }
            });
        }
    </script>
</head>

<body onload="populateTables();">
<div class="col-sm-8 col-sm-offset-2">
    <header role="banner">
        <h1>Budget: Net Worth</h1>
        <hr/>
        <div class="accent-bar">
            <ul class="accents">
                <li><input class="btn btn-toolbar" id="menu-accounts" type="button" value="Accounts"/></li>
                <li><input class="btn btn-toolbar" id="menu-uploads" type="button" value="Upload CSV"/></li>
                <li><input class="btn btn-toolbar" id="menu-transactions" type="button" value="Transactions"/></li>
            </ul>
        </div>
        <hr/>
    </header>
</div>

<div class="col-sm-8 col-sm-offset-2">
    <div id="accounts-page">
        <h3>Create New Account</h3>
        <form action="accounts" id="create-account" method="POST">
            <div class="form-group" id="account-name-group">
                <label for="account-name">Account Name</label>
                <input
                        class="form-control"
                        id="account-name"
                        name="account-name"
                        placeholder="Account Name"
                        required
                        type="text"
                />
            </div>

            <button class="btn btn-success" type="submit">
                Create
            </button>
        </form>
        <hr/>

        <h3>Accounts</h3>
        <table class="table" id="accounts-table">
            <thead>
            <tr>
                <th>Account Name</th>
                <th></th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>


    <div hidden id="upload-page">
        <div id="upload-transactions-wrapper">
            <h3>Upload Transactions</h3>
            <form action="accounts/transactions" enctype="multipart/form-data" id="upload-transactions" method="POST">
                <div class="form-group" id="file-group">
                    <label for="transactions-file">CSV file: </label>
                    <input accept="text/csv" id="transactions-file" name="transactions-file" required type="file"/>
                </div>

                <div class="form-group" id="file-account-group">
                    <label for="file-account">Account: </label>
                    <select id="file-account" name="file-account" required>
                        <option disabled selected value> No chosen account</option>
                    </select>
                </div>

                <button class="btn btn-success" type="submit">
                    Upload
                </button>
            </form>
        </div>

        <div hidden id="map-headers-wrapper">
            <hr/>
            <h3>Select Headers</h3>
            <form id="map-headers" method="POST">
                <div class="form-group" id="transaction-date-header-group">
                    <label for="transaction-date-header">Transaction Date Header: </label>
                    <select id="transaction-date-header" name="transaction-date-header" required>
                        <option disabled selected></option>
                    </select>
                </div>

                <div class="form-group" id="memo-header-group">
                    <label for="memo-header">Memo Header: </label>
                    <select id="memo-header" name="memo-header" required>
                        <option disabled selected></option>
                    </select>
                </div>

                <div class="form-group" id="debit-group">
                    <label for="debit-header">Amount/Deposit Header: </label>
                    <select id="debit-header" name="debit-header" required>
                        <option disabled selected></option>
                    </select>
                </div>

                <div class="form-group" id="credit-group">
                    <label for="credit-header">Credit/Withdrawal Header <i>(opt.)</i>: </label>
                    <select id="credit-header" name="credit-header">
                        <option disabled selected></option>
                    </select>
                </div>

                <button class="btn btn-success" type="submit">
                    Apply
                </button>
            </form>
        </div>

        <div hidden id="finalize-upload-wrapper">
            <hr/>
            <h3>Review Upload</h3>
            <form id="finalize-upload" method="POST">
                <button class="btn btn-success" type="submit">
                    Approve
                </button>
            </form>
            <table class="table" id="review-upload-table">
                <thead>
                <tr>
                    <th>Transaction Date</th>
                    <th>Memo</th>
                    <th>Amount</th>
                </tr>
                </thead>

                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div hidden id="transactions-page">
        <table class="table" id="transactions-table">
            <thead>
            <tr>
                <th>Transaction Date</th>
                <th>Memo</th>
                <th>Amount</th>
            </tr>
            </thead>

            <tbody>
            </tbody>
        </table>
    </div>

</div>

</body>
</html>
