<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BNW: Dashboard</title>
    <link
            href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <style>
        hr {
            border: 0;
            border-top: 2px solid darkgray;
            border-radius: 5px;
        }
    </style>
    <script type="text/javascript">
        const headerInputs = ['#transaction-date-header', '#memo-header', '#debit-header'];
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#create-account").submit(function (event) {
                event.preventDefault();

                const formData = new FormData(event.target);
                const formDataObj = {};
                formData.forEach((value, key) => (formDataObj[key] = value));

                $.ajax({
                    type: "POST",
                    url: event.target.action,
                    data: formDataObj,
                    dataType: "json",
                    success: function (response) {
                        event.target.reset();
                        appendAccountToAccountsTable(response);
                        appendAccountToUploadTransactionsList(response);
                    }
                });

            });

        });
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#upload-transactions").submit(function (event) {
                event.preventDefault();

                const formData = event.target;
                const action = "accounts/" + formData["file-account"].value + "/stage-upload";
                const transactionsFile = $("#transactions-file");
                const fileInput = transactionsFile[0];
                const file = fileInput.files[0];
                const fd = new FormData();
                fd.append('file', file);

                $.ajax({
                    type: "POST",
                    dataType: "json",
                    processData: false,
                    contentType: false,
                    url: action,
                    data: fd,
                    success: function (response) {
                        event.target.reset();

                        console.log(response);


                        response.uploadHeaders.forEach(function (item) {
                            headerInputs.forEach(function (headerInput) {
                                $(headerInput).append(
                                    $('<option></option>').val(item.id).html(item.value)
                                );
                            });
                        });

                        let mapHeaders = $("#map-headers");
                        mapHeaders.attr('action', "uploads/" + response.uploadId + "/map-headers");
                    }
                });
            });
        })
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#map-headers").submit(function (event) {
                event.preventDefault();

                const formData = new FormData(event.target);
                const formDataObj = {};
                formData.forEach((value, key) => (formDataObj[key] = value));

                $.ajax({
                    type: "POST",
                    url: event.target.action,
                    data: formDataObj,
                    dataType: "json",
                    success: function () {
                        event.target.reset();

                        headerInputs.forEach(function (headerInput) {
                            $(headerInput + " > option").each(function () {
                                if (this.value) {
                                    this.remove();
                                }
                            })
                        });
                    }
                });
            });
        })
    </script>
    <script type="text/javascript">
        function populateAccounts() {
            $.ajax({
                type: "GET",
                url: "accounts",
                dataType: "json",
                success: function (response) {
                    $.each(response, function (i, item) {
                        appendAccountToAccountsTable(item);
                        appendAccountToUploadTransactionsList(item);
                    });
                }
            });
        }
    </script>
    <script type="text/javascript">
        function appendAccountToAccountsTable(item) {
            const trHtml = '<tr id ="' + item.id + '"><td>' + item.accountName + '</td><td><button type="button"' +
                ' class="btn btn-danger" value="' + item.id + '" onclick="deleteAccount(this.value);" style="float: right;">Delete</button></td></tr>';
            $('#accounts-table').append(trHtml);
        }
    </script>
    <script type="text/javascript">
        function appendAccountToUploadTransactionsList(item) {
            const select = document.getElementById('file-account');
            select.options[select.options.length] = new Option(item.accountName, item.id);
        }
    </script>
    <script type="text/javascript">
        function deleteAccount(id) {
            $.ajax({
                type: "DELETE",
                url: "accounts/" + id,
                dataType: "json",
                success: function () {
                    $('#' + id).remove();
                    document.getElementById('file-account').remove(id);

                    const fileAccountOptions = document.getElementById("file-account");
                    for (let i = 0; i < fileAccountOptions.length; i++) {
                        if (fileAccountOptions.options[i].value === id) {
                            fileAccountOptions.options[i].remove();
                        }
                    }
                }
            });
        }
    </script>
</head>

<body onload="populateAccounts();">
<div class="col-sm-8 col-sm-offset-2">
    <header role="banner">
        <h1>Budget: Net Worth</h1>
    </header>
</div>

<div class="col-sm-8 col-sm-offset-2">
    <h3>Create New Account</h3>
    <form action="accounts" id="create-account" method="POST">
        <div class="form-group" id="account-name-group">
            <label for="account-name">Account Name</label>
            <input
                    class="form-control"
                    id="account-name"
                    name="account-name"
                    placeholder="Account Name"
                    required
                    type="text"
            />
        </div>

        <button class="btn btn-success" type="submit">
            Create
        </button>
    </form>

    <hr/>

    <h3>Accounts</h3>
    <table class="table" id="accounts-table">
        <thead>
        <tr>
            <th>Account Name</th>
            <th></th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>

    <hr/>

    <h3>Upload Transactions</h3>
    <form action="accounts/transactions" enctype="multipart/form-data" id="upload-transactions" method="POST">
        <div class="form-group" id="file-group">
            <label for="transactions-file">CSV file: </label>

            <input accept="text/csv" id="transactions-file" name="transactions-file" required type="file"/>
        </div>

        <div class="form-group" id="file-account-group">
            <label for="file-account">Account: </label>
            <select id="file-account" name="file-account" required>
                <option disabled selected value> No chosen account</option>
            </select>
        </div>

        <button class="btn btn-success" type="submit">
            Upload
        </button>

    </form>

    <hr/>

    <h3>Map Upload Headers</h3>
    <form id="map-headers" method="POST">
        <div class="form-group" id="transaction-date-header-group">
            <label for="transaction-date-header">Transaction Date Header: </label>
            <select id="transaction-date-header" name="transaction-date-header" required>
                <option disabled selected value> -- Choose Header --</option>
            </select>
        </div>

        <div class="form-group" id="memo-header-group">
            <label for="memo-header">Memo Header: </label>
            <select id="memo-header" name="memo-header" required>
                <option disabled selected value> -- Choose Header --</option>
            </select>
        </div>

        <div class="form-group" id="debit-group">
            <label for="debit-header">Debit Header: </label>
            <select id="debit-header" name="debit-header" required>
                <option disabled selected value> -- Choose Header --</option>
            </select>
        </div>

        <button class="btn btn-success" type="submit">
            Confirm Mappings
        </button>
    </form>
</div>

</body>
</html>
